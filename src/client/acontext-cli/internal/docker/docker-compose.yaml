name: acontext-server
services:
  # --- PostgreSQL ---
  acontext-server-pg:
    image: pgvector/pgvector:pg16
    container_name: acontext-server-pg
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USER:-acontext}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-helloworld}
      POSTGRES_DB: ${DATABASE_NAME:-acontext}
    ports:
      - "${DATABASE_EXPORT_PORT:-15432}:5432"
    volumes:
      - ${DATABASE_LOCATION:-./acontext_data/pg}:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DATABASE_USER:-acontext} -d ${DATABASE_NAME:-acontext}",
        ]
      interval: 30s
      timeout: 5s
      retries: 5

  # --- Redis ---
  acontext-server-redis:
    image: redis:7.4
    container_name: acontext-server-redis
    restart: unless-stopped
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:-helloworld}"]
    ports:
      - "${REDIS_EXPORT_PORT:-16379}:6379"
    volumes:
      - ${REDIS_LOCATION:-./acontext_data/redis}:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-helloworld}", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5

  # --- RabbitMQ ---
  acontext-server-rabbitmq:
    image: rabbitmq:4-management
    container_name: acontext-server-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-acontext}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-helloworld}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    ports:
      - "${RABBITMQ_EXPORT_PORT:-15672}:5672" # AMQP
      - "${RABBITMQ_ADMIN_EXPORT_PORT:-25672}:15672" # UI
    volumes:
      - ${RABBITMQ_LOCATION:-./acontext_data/rabbitmq}:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5

  # --- SeaweedFS ---
  acontext-server-seaweedfs:
    image: chrislusf/seaweedfs:4.00
    container_name: acontext-server-seaweedfs
    restart: unless-stopped
    user: root  # https://github.com/seaweedfs/seaweedfs/pull/7399
    environment:
      # S3 credentials - no config file needed!
      WEED_S3_ACCESS_KEY: ${S3_ACCESS_KEY:-acontext}
      WEED_S3_SECRET_KEY: ${S3_SECRET_KEY:-helloworld}
      # Storage settings
      WEED_MASTER_VOLUME_GROWTH_COPY_1: 1
      WEED_MASTER_DEFAULT_REPLICATION: "000"
    command: >
      server
      -s3
      -s3.port=9000
      -dir=/data
      -volume.max=100
      -volume.publicUrl=${S3_ENDPOINT:-http://127.0.0.1:19000}
      -ip=acontext-server-seaweedfs
      -ip.bind=0.0.0.0
      -metricsPort=9324
    ports:
      - "${S3_API_EXPORT_PORT:-19000}:9000" # S3 API (compatible with MinIO port)
      - "${S3_CONSOLE_EXPORT_PORT:-19001}:8888" # Filer UI (mapped to 9001 for consistency)
      - "9333:9333" # Master UI (additional)
    volumes:
      - ${S3_LOCATION:-./acontext_data/s3}:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -O- http://acontext-server-seaweedfs:9333/cluster/status || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 5

  # init Bucket for SeaweedFS
  acontext-server-seaweedfs-setup:
    image: amazon/aws-cli:2.32.6
    container_name: acontext-server-seaweedfs-setup
    depends_on:
      acontext-server-seaweedfs:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY:-acontext}
      AWS_SECRET_ACCESS_KEY: ${S3_SECRET_KEY:-helloworld}
      AWS_DEFAULT_REGION: ${S3_REGION:-auto}
    entrypoint: >
      /bin/sh -c "
      aws configure set default.s3.signature_version s3v4 &&
      aws --endpoint-url=http://acontext-server-seaweedfs:9000 s3 mb s3://${S3_BUCKET:-acontext-assets} 2>/dev/null || true &&
      echo 'âœ… SeaweedFS ready with bucket: ${S3_BUCKET:-acontext-assets}'
      "
    restart: "no"

  # --- Jaeger (OpenTelemetry Collector) ---
  acontext-server-jaeger:
    image: jaegertracing/all-in-one:1.75.0
    container_name: acontext-server-jaeger
    restart: unless-stopped
    user: root  # Run as root to ensure write permissions to mounted volume
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
      # Use Badger as storage backend (local file storage, suitable for development)
      SPAN_STORAGE_TYPE: "badger"
      BADGER_EPHEMERAL: "false"  # Disable ephemeral storage, enable persistence
      BADGER_DIRECTORY: "/badger/data"
      BADGER_SPAN_STORE_TTL: "168h"  # Data retention: 7 days
    ports:
      - "${JAEGER_UI_EXPORT_PORT:-16686}:16686"  # Jaeger UI
      - "${JAEGER_OTLP_GRPC_EXPORT_PORT:-4317}:4317"  # OTLP gRPC receiver
      - "${JAEGER_OTLP_HTTP_EXPORT_PORT:-4318}:4318"  # OTLP HTTP receiver
      - "14250:14250"  # gRPC (model.proto)
      - "14268:14268"  # HTTP (thrift)
    volumes:
      - ${JAEGER_STORAGE_LOCATION:-./acontext_data/jaeger}:/badger/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 30s
      timeout: 5s
      retries: 5

  # acontext-server-core
  acontext-server-core:
    image: ${CORE_IMAGE:-ghcr.io/memodb-io/acontext-core:latest}
    pull_policy: always
    container_name: acontext-server-core
    restart: unless-stopped
    environment:
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_BASE_URL: ${LLM_BASE_URL}
      LLM_SDK: ${LLM_SDK}
      LLM_SIMPLE_MODEL: ${LLM_SIMPLE_MODEL:-gpt-4.1}
      LLM_RESPONSE_TIMEOUT: ${LLM_RESPONSE_TIMEOUT:-60}
      BLOCK_EMBEDDING_PROVIDER: ${BLOCK_EMBEDDING_PROVIDER:-openai}
      BLOCK_EMBEDDING_MODEL: ${BLOCK_EMBEDDING_MODEL:-text-embedding-3-small}
      BLOCK_EMBEDDING_DIM: ${BLOCK_EMBEDDING_DIM:-1536}
      BLOCK_EMBEDDING_API_KEY: ${BLOCK_EMBEDDING_API_KEY:-}
      BLOCK_EMBEDDING_BASE_URL: ${BLOCK_EMBEDDING_BASE_URL:-}
      BLOCK_EMBEDDING_SEARCH_COSINE_DISTANCE_THRESHOLD: ${BLOCK_EMBEDDING_SEARCH_COSINE_DISTANCE_THRESHOLD:-0.8}
      DATABASE_URL: postgresql://${DATABASE_USER:-acontext}:${DATABASE_PASSWORD:-helloworld}@acontext-server-pg:5432/${DATABASE_NAME:-acontext}
      MQ_URL: amqp://${RABBITMQ_USER:-acontext}:${RABBITMQ_PASSWORD:-helloworld}@acontext-server-rabbitmq:5672/
      REDIS_URL: redis://:${REDIS_PASSWORD:-helloworld}@acontext-server-redis:6379
      S3_ENDPOINT: http://acontext-server-seaweedfs:9000
      OTEL_EXPORTER_OTLP_ENDPOINT: acontext-server-jaeger:4317
    ports:
      - "${CORE_EXPORT_PORT:-8019}:8000"
    volumes:
      - ${CORE_CONFIG_YAML_FILE:-./config.yaml}:/app/config.yaml:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -O- http://localhost:8000/health || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 5
    depends_on:
      acontext-server-pg:
        condition: service_healthy
      acontext-server-redis:
        condition: service_healthy
      acontext-server-rabbitmq:
        condition: service_healthy
      acontext-server-seaweedfs:
        condition: service_healthy
      acontext-server-seaweedfs-setup:
        condition: service_completed_successfully
      acontext-server-jaeger:
        condition: service_healthy

  # acontext-server-api
  acontext-server-api:
    image: ${API_IMAGE:-ghcr.io/memodb-io/acontext-api:latest}
    pull_policy: always
    container_name: acontext-server-api
    restart: unless-stopped
    environment:
      API_EXPORT_PORT: ${API_EXPORT_PORT:-8029}
      ROOT_API_BEARER_TOKEN: ${ROOT_API_BEARER_TOKEN:-your-root-api-bearer-token}
      DATABASE_HOST: ${DATABASE_HOST:-acontext-server-pg}
      DATABASE_USER: ${DATABASE_USER:-acontext}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-helloworld}
      DATABASE_NAME: ${DATABASE_NAME:-acontext}
      DATABASE_EXPORT_PORT: ${DATABASE_EXPORT_PORT:-5432}
      REDIS_HOST: acontext-server-redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-helloworld}
      REDIS_EXPORT_PORT: ${REDIS_EXPORT_PORT:-6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-acontext-server-rabbitmq}
      RABBITMQ_USER: ${RABBITMQ_USER:-acontext}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-helloworld}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/}
      RABBITMQ_VHOST_ENCODED: ${RABBITMQ_VHOST_ENCODED:-%2F}
      RABBITMQ_EXPORT_PORT: ${RABBITMQ_EXPORT_PORT:-5672}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://127.0.0.1:19000}
      S3_INTERNAL_ENDPOINT: http://acontext-server-seaweedfs:9000
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-acontext}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-helloworld}
      S3_BUCKET: ${S3_BUCKET:-acontext-assets}
      CORE_BASE_URL: http://acontext-server-core:8000
      OTEL_EXPORTER_OTLP_ENDPOINT: acontext-server-jaeger:4317
      APP_ENV: ${APP_ENV:-development}
    ports:
      - "${API_EXPORT_PORT:-8029}:8029"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -O- http://acontext-server-api:8029/health || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 5
    depends_on:
      acontext-server-core:
        condition: service_healthy
      acontext-server-seaweedfs-setup:
        condition: service_completed_successfully

  # acontext-server-ui
  acontext-server-ui:
    image: ${UI_IMAGE:-ghcr.io/memodb-io/acontext-ui:latest}
    pull_policy: always
    container_name: acontext-server-ui
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
      NEXT_PUBLIC_BASE_PATH: ""
      API_SERVER_URL: http://acontext-server-api:8029
      ROOT_API_BEARER_TOKEN: ${ROOT_API_BEARER_TOKEN:-your-root-api-bearer-token}
      DATABASE_URL: postgresql://${DATABASE_USER:-acontext}:${DATABASE_PASSWORD:-helloworld}@acontext-server-pg:5432/${DATABASE_NAME:-acontext}
      JAEGER_INTERNAL_URL: http://acontext-server-jaeger:16686
      JAEGER_URL: ${JAEGER_URL:-http://localhost:16686}
    ports:
      - "${UI_EXPORT_PORT:-3000}:3000"
    depends_on:
      - acontext-server-api

